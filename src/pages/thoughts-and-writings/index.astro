---
import Layout from "../../layouts/Layout.astro";
import BlogPostCard from "../../components/BlogPostCard.astro";
import {
    processCollectionBlogPost,
    sortPostsByDate,
} from "../../lib/blog-utils";
import { getCollection } from "astro:content";

// Get all blog posts from the collection
const allPosts = await getCollection("blog");

// Transform and sort posts
const blogPosts = allPosts.map(processCollectionBlogPost);
const sortedPosts = sortPostsByDate(blogPosts);

// Extract all unique tags
const allTags = Array.from(
    new Set(sortedPosts.flatMap((post) => post.tags))
).sort();

// Serialize posts for client-side filtering
const postsData = JSON.stringify(sortedPosts);
---

<Layout
    title="Thoughts and Writings - Daniel Madeley"
    description="Thoughts on design, development, and the intersection of technology and creativity. Articles about web development, design systems, and engineering."
    keywords="blog, web development, design, engineering, JavaScript, TypeScript, React, Vue, Angular"
>
    <div class="flex flex-col gap-4 border-b pb-8 border-neutral-200">
        <div class="flex items-start justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-stone-400">Thoughts & Writings</h2>
                <p class="text-xs text-stone-200 max-w-[500px] mt-2">
                    Exploring the intersection of design, development, and digital
                    innovation through articles and insights.
                </p>
            </div>
            <div id="results-count" class="text-xs text-stone-400 whitespace-nowrap pt-1">
                {sortedPosts.length} {sortedPosts.length === 1 ? 'article' : 'articles'}
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="py-6 ">
        <div class="flex items-center gap-1 overflow-x-auto pb-2 -mb-2 scrollbar-hide">
            <button
                data-filter="all"
                class="filter-tag active px-4 py-2 text-sm text-stone-400 hover:text-stone-100 transition-colors whitespace-nowrap border-b-2 border-transparent"
            >
                All
            </button>
            {allTags.map((tag) => {
                const tagCount = sortedPosts.filter((post) => post.tags.includes(tag)).length;
                return (
                    <button
                        data-filter={tag}
                        data-count={tagCount}
                        class="filter-tag px-4 py-2 text-sm text-stone-400 hover:text-stone-100 transition-colors whitespace-nowrap border-b-2 border-transparent"
                    >
                        {tag}
                        <span class="ml-1.5 text-stone-500">({tagCount})</span>
                    </button>
                );
            })}
        </div>
    </div>

    <!-- Posts Grid -->
    <div id="posts-container" class="grid grid-cols-1 gap-8 mb-12">
        {sortedPosts.map((post) => (
            <div
                class="post-item"
                data-slug={post.slug}
                data-tags={JSON.stringify(post.tags)}
            >
                <BlogPostCard post={post} variant="compact" showAuthor={false} maxTags={3} />
            </div>
        ))}
    </div>

    <!-- Empty State -->
    <div
        id="empty-state"
        class="text-center py-12 hidden"
    >
        <p class="text-stone-400 text-lg mb-2">
            No articles found.
        </p>
        <p class="text-stone-500 text-sm">
            Try selecting a different filter or <button id="clear-filter" class="text-stone-400 hover:text-stone-300 underline">view all articles</button>.
        </p>
    </div>

    <!-- Pagination -->
    <div
        id="pagination"
        class="flex items-center justify-center gap-4 pt-8 "
        style="display: none;"
    >
        <button
            id="prev-btn"
            class="px-4 py-2 text-sm text-stone-400 hover:text-stone-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
        >
            Previous
        </button>
        <span
            id="page-info"
            class="text-sm text-stone-400"
        ></span>
        <button
            id="next-btn"
            class="px-4 py-2 text-sm text-stone-400 hover:text-stone-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
            Next
        </button>
    </div>

    <script define:vars={{ postsData, allTags }}>
        const POSTS_PER_PAGE = 6;
        let allPosts = JSON.parse(postsData);
        let filteredPosts = [...allPosts];
        let currentPage = 1;
        let activeFilter = "all";

        const postsContainer = document.getElementById("posts-container");
        const emptyState = document.getElementById("empty-state");
        const resultsCount = document.getElementById("results-count");
        const clearFilterBtn = document.getElementById("clear-filter");
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const pageInfo = document.getElementById("page-info");
        const filterButtons = document.querySelectorAll(".filter-tag");
        const postItems = document.querySelectorAll(".post-item");

        function filterPosts(tag) {
            activeFilter = tag;
            if (tag === "all") {
                filteredPosts = [...allPosts];
            } else {
                filteredPosts = allPosts.filter((post) =>
                    post.tags.includes(tag)
                );
            }
            currentPage = 1;
            renderPosts();
            updatePagination();
        }

        function renderPosts() {
            const start = (currentPage - 1) * POSTS_PER_PAGE;
            const end = start + POSTS_PER_PAGE;
            const postsToShow = filteredPosts.slice(start, end);
            const slugsToShow = new Set(postsToShow.map((p) => p.slug));

            // Hide all posts first
            postItems.forEach((item) => {
                item.style.display = "none";
            });

            // Show posts that match current page
            postItems.forEach((item) => {
                const slug = item.dataset.slug;
                if (slugsToShow.has(slug)) {
                    item.style.display = "block";
                }
            });

            // Update results count
            const count = filteredPosts.length;
            resultsCount.textContent = `${count} ${count === 1 ? 'article' : 'articles'}`;

            // Show/hide empty state
            if (filteredPosts.length === 0) {
                postsContainer.style.display = "none";
                emptyState.classList.remove("hidden");
            } else {
                postsContainer.style.display = "grid";
                emptyState.classList.add("hidden");
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
            const paginationEl = document.getElementById("pagination");
            
            if (totalPages > 1) {
                paginationEl.style.display = "flex";
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                paginationEl.style.display = "none";
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderPosts();
                updatePagination();
                window.scrollTo({ top: 0, behavior: "smooth" });
            }
        }

        // Filter button handlers
        filterButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                filterButtons.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                const filter = btn.dataset.filter;
                filterPosts(filter);
            });
        });

        // Pagination handlers
        prevBtn.addEventListener("click", () => goToPage(currentPage - 1));
        nextBtn.addEventListener("click", () => goToPage(currentPage + 1));

        // Clear filter handler
        if (clearFilterBtn) {
            clearFilterBtn.addEventListener("click", () => {
                const allBtn = document.querySelector('[data-filter="all"]');
                if (allBtn) {
                    allBtn.click();
                }
            });
        }

        // Initial render
        renderPosts();
        updatePagination();
    </script>

    <style>
        .filter-tag.active {
            border-bottom-color: rgb(168 162 158) !important;
            color: rgb(245 245 244) !important;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</Layout>
