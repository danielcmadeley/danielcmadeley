---
import Layout from "../../layouts/Layout.astro";
import {
    processCollectionBlogPost,
    sortPostsByDate,
    formatCompactDate,
} from "../../lib/blog-utils";
import { getCollection } from "astro:content";
import ViewCount from "../../components/ViewCount.tsx";

const allPosts = await getCollection("blog");
const blogPosts = allPosts.map(processCollectionBlogPost);
const sortedPosts = sortPostsByDate(blogPosts);

const featuredPost = sortedPosts[0];
const remainingPosts = sortedPosts.slice(1);

const allTags = Array.from(
    new Set(sortedPosts.flatMap((post) => post.tags))
).sort();

const postsData = JSON.stringify(sortedPosts);
---

<Layout
    title="Thoughts and Writings - Daniel Madeley"
    description="Exploring structural engineering, computational design, Python automation, and the intersection of engineering and technology."
    keywords="blog, structural engineering, computational design, Python, automation, BIM, FEA, Grasshopper"
>
    <!-- Header -->
    <header class="pt-12 pb-8">
        <h1 class="text-5xl md:text-6xl font-bold text-neutral-100 mb-4">
            Thoughts + Writings
        </h1>
        <p class="text-lg text-neutral-400 max-w-xl">
            Thoughts on structural engineering, computational design, and software development.
        </p>
    </header>

    <!-- Filter pills -->
    <nav class="mb-12 border-b border-neutral-800 pb-6">
        <div class="flex items-center gap-3 overflow-x-auto scrollbar-hide">
            <button
                data-filter="all"
                class="filter-tag active px-4 py-1.5 text-sm rounded-full border border-neutral-700 text-neutral-100 bg-neutral-800 transition-all whitespace-nowrap"
            >
                All
            </button>
            {allTags.map((tag) => (
                <button
                    data-filter={tag}
                    class="filter-tag px-4 py-1.5 text-sm rounded-full border border-neutral-800 text-neutral-400 hover:text-neutral-200 hover:border-neutral-600 transition-all whitespace-nowrap"
                >
                    {tag}
                </button>
            ))}
        </div>
    </nav>

    <!-- Featured post -->
    {featuredPost && (
        <section id="featured-section" class="mb-16">
            <a href={`/thoughts-and-writings/${featuredPost.slug}`} class="group block">
                <div class="border border-neutral-800 rounded-2xl p-8 md:p-10 transition-colors hover:border-neutral-600">
                    <div class="flex items-center gap-3 text-sm text-neutral-500 mb-4">
                        <time datetime={featuredPost.pubDate}>
                            {formatCompactDate(featuredPost.pubDate)}
                        </time>
                        <span class="text-neutral-700">&middot;</span>
                        <span>{featuredPost.readingTime} min read</span>
                        {featuredPost.tags[0] && (
                            <>
                                <span class="text-neutral-700">&middot;</span>
                                <span>{featuredPost.tags[0]}</span>
                            </>
                        )}
                    </div>
                    <h2 class="text-3xl md:text-4xl font-bold text-neutral-100 mb-4 group-hover:text-white transition-colors">
                        {featuredPost.title}
                    </h2>
                    <p class="text-neutral-400 text-lg leading-relaxed max-w-3xl">
                        {featuredPost.description}
                    </p>
                </div>
            </a>
        </section>
    )}

    <!-- Post list -->
    <section>
        <div id="posts-container">
            {remainingPosts.map((post) => (
                <div
                    class="post-item"
                    data-slug={post.slug}
                    data-tags={JSON.stringify(post.tags)}
                >
                    <a href={`/thoughts-and-writings/${post.slug}`} class="group block border-b border-neutral-800 py-6 hover:bg-neutral-800/20 transition-colors -mx-4 px-4 rounded">
                        <div class="flex flex-col md:flex-row md:items-start md:gap-8">
                            <div class="flex items-center gap-3 text-sm text-neutral-500 md:w-44 md:shrink-0 mb-2 md:mb-0 md:pt-1">
                                <time datetime={post.pubDate} class="whitespace-nowrap">
                                    {formatCompactDate(post.pubDate)}
                                </time>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-neutral-200 group-hover:text-white transition-colors mb-1">
                                    {post.title}
                                </h3>
                                <p class="text-neutral-500 text-sm leading-relaxed line-clamp-2">
                                    {post.description}
                                </p>
                                <div class="flex items-center gap-3 mt-2 text-xs text-neutral-600">
                                    <span>{post.readingTime} min read</span>
                                    <ViewCount client:load slug={post.slug} />
                                    {post.tags.slice(0, 2).map((tag) => (
                                        <span class="px-2 py-0.5 rounded-full border border-neutral-800 text-neutral-500">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            ))}
        </div>

        <!-- Filtered posts container -->
        <div id="filtered-posts-container" class="hidden">
            {sortedPosts.map((post) => (
                <div
                    class="filtered-post-item"
                    data-slug={post.slug}
                    data-tags={JSON.stringify(post.tags)}
                >
                    <a href={`/thoughts-and-writings/${post.slug}`} class="group block border-b border-neutral-800 py-6 hover:bg-neutral-800/20 transition-colors -mx-4 px-4 rounded">
                        <div class="flex flex-col md:flex-row md:items-start md:gap-8">
                            <div class="flex items-center gap-3 text-sm text-neutral-500 md:w-44 md:shrink-0 mb-2 md:mb-0 md:pt-1">
                                <time datetime={post.pubDate} class="whitespace-nowrap">
                                    {formatCompactDate(post.pubDate)}
                                </time>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-neutral-200 group-hover:text-white transition-colors mb-1">
                                    {post.title}
                                </h3>
                                <p class="text-neutral-500 text-sm leading-relaxed line-clamp-2">
                                    {post.description}
                                </p>
                                <div class="flex items-center gap-3 mt-2 text-xs text-neutral-600">
                                    <span>{post.readingTime} min read</span>
                                    <ViewCount client:load slug={post.slug} />
                                    {post.tags.slice(0, 2).map((tag) => (
                                        <span class="px-2 py-0.5 rounded-full border border-neutral-800 text-neutral-500">
                                            {tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            ))}
        </div>
    </section>

    <!-- Empty state -->
    <div id="empty-state" class="text-center py-20 hidden">
        <p class="text-neutral-400 text-lg mb-2">No articles found</p>
        <p class="text-neutral-600 text-sm">
            Try a different topic or
            <button id="clear-filter" class="text-neutral-400 hover:text-neutral-200 underline underline-offset-2">
                view all
            </button>
        </p>
    </div>

    <script define:vars={{ postsData, allTags }}>
        const allPosts = JSON.parse(postsData);
        let activeFilter = "all";

        const featuredSection = document.getElementById("featured-section");
        const postsContainer = document.getElementById("posts-container");
        const filteredContainer = document.getElementById("filtered-posts-container");
        const emptyState = document.getElementById("empty-state");
        const clearFilterBtn = document.getElementById("clear-filter");
        const filterButtons = document.querySelectorAll(".filter-tag");
        const filteredPostItems = document.querySelectorAll(".filtered-post-item");

        function filterPosts(tag) {
            activeFilter = tag;

            if (tag === "all") {
                if (featuredSection) featuredSection.style.display = "block";
                postsContainer.style.display = "block";
                filteredContainer.classList.add("hidden");
                emptyState.classList.add("hidden");
            } else {
                if (featuredSection) featuredSection.style.display = "none";
                postsContainer.style.display = "none";
                filteredContainer.classList.remove("hidden");

                const filteredPosts = allPosts.filter(post => post.tags.includes(tag));

                filteredPostItems.forEach(item => {
                    const tags = JSON.parse(item.dataset.tags || "[]");
                    item.style.display = tags.includes(tag) ? "block" : "none";
                });

                if (filteredPosts.length === 0) {
                    filteredContainer.classList.add("hidden");
                    emptyState.classList.remove("hidden");
                } else {
                    emptyState.classList.add("hidden");
                }
            }
        }

        filterButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                filterButtons.forEach((b) => {
                    b.classList.remove("active", "bg-neutral-800", "text-neutral-100", "border-neutral-700");
                    b.classList.add("text-neutral-400", "border-neutral-800");
                });
                btn.classList.add("active", "bg-neutral-800", "text-neutral-100", "border-neutral-700");
                btn.classList.remove("text-neutral-400", "border-neutral-800");
                filterPosts(btn.dataset.filter);
            });
        });

        if (clearFilterBtn) {
            clearFilterBtn.addEventListener("click", () => {
                const allBtn = document.querySelector('[data-filter="all"]');
                if (allBtn) allBtn.click();
            });
        }
    </script>

    <style>
        .filter-tag.active {
            background-color: rgb(38 38 38) !important;
            color: rgb(245 245 245) !important;
            border-color: rgb(64 64 64) !important;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</Layout>
